# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Auto Upload

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -B package --file backend/pom.xml

    - name: Copy Jar file to EC2 via SSH Key
      uses: appleboy/scp-action@master
      with:
        host: ec2-18-119-130-187.us-east-2.compute.amazonaws.com
        username: ec2-user
        port: 22
        key: MIIEogIBAAKCAQEAkQVrp7DFbc+72V3PD5EM7AjfGwcdXnw3wrMY0B9Cou0EK2jEsG/JNiCI2eoT4GhySvntw49Xy8aaQlRqcojMMIJnaiF/Dg8YpM56+uDldgpVUyhlWAfFXlHFrGu4YW6KMIlXEYRDMMGhxENznhXwy56a9wQ4JULz6gjczMy264Vo4LnANeCE/EMav1RlCe3iNmNbd5fGeR8L3smQ6WR2nlISu9ph7C4hsFW/uPfBF4CaqohjBCCs1yKE2tmptMRAwFcqkuWMnDvP3o65GkVH8qQt/wkZhoZJuSGf8oIfGgGtJubwGRaDu8vpg9qFhlaVRPgCMcotcgyVWtbj6QXpyQIDAQABAoIBAESHVDT8wn6+sFzqCGOpvnp3Qr5p4UX52vulWC9Y5ktJRzQgIPnjCSkLvL+E7nmXwZKOgf1saieAJPr9GwQegqbVqHqtc3W4SoPukoyk46mg/mr6ZtFvcqO8bnWovYtFCgYfkEZVws5yYbf1y9fDNHNz8nSRyNpKxiosn/IjNrkaLG5HMndiU+Flc6PqF7fgQk3Uo+Xu2A9EPcjVpcGiZSj93RQi9Vcu2wpl1AYvlH7BLPRdCuEID9cw15fG39Kfj7uTxZZTh1jBq8DN6W3N6e4m12m62TpCMudHs1SiVhCrGVKuPwt1q0J+i55E/vpWJV30RV/cduSVWKW4dUZmyvUCgYEA4b9jtEMUSNiQg2tkw6yQ0r6T7QPRsFODwRPoZ1jR78MvwDn5/mk6KqbVPt1Ex3W8JXy8K14sbnvsbp028cy73TkHfjQE1hB9frNa2chZ+SbBiPdKsbeQl37wehg1czTlGXaTMJqCEtNCKz4cD52r79N16rSeOnrQdOeNGQSOgjcCgYEApHSW48+CsglAOeP4hycFVi1uJ8/L9KabxWxCcaUSVY+HrvdbeG61BfbJv3FF/HbowfGgi1o+RQZvNYHWVi+blZrXI/3ryM3IcocaKYEgFyv3fvWFyi1IiCGWHbUnQrKWIiTvgSb3pclmgMGE2bjYR2Nka9Iq3CZ5l+G5vlZI8/8CgYAznfhlOkVEFsiMVBz5JNcEaPEX65yhjab9mdi08Lkn8mBTuq3vvw2+vODbe+qDFOeNRsUbwW+1X36DGE184kw+XBDbiXdlnuWi982ZKFdyQatU7v5UPl3AVhUURb7K9dhAhz1Gir2dIlLp4ky2QV4T+yzmGqBnTLenU16Oztzq5wKBgFe0UfBGb5YRNu5otNcnKUJvUgrrWAMug26DMOA4v5FfzWWzR1Xv/Jyko610dHWS2Mjt2sfWpdTb/J0VlEA8fYYIoOnx9jgN/vONN5eg5INXEFPmDqbnBYKMHunS/ZAle8nT1uMS7Am/YeoSyo3udXGFAT47RF5KKpikahGnJJrzAoGASlHwplCsOI9OQrLTtjA85tHqyW1A9wBQAutSe+rCzs1a8T6Hja3Vq2KWuVlCocMFoREMu33OFUSq94VpC7x6kHluE9CKUxUbN1x87RMuApoSxL7uUMqDG2atjhhHsKzFmA1v+P1UvVmKLjuOjEb1UXCRKSLaD/qeRLoczpA6y9o=

        source: "backend/target/TSA-New.jar"
        target: "~/"

    - name: Run commands to start the Java server
      uses: appleboy/ssh-action@v0.1.9  #HERE
      with:
        host: ec2-18-119-130-187.us-east-2.compute.amazonaws.com
        username: ec2-user
        key: ${{ secrets.KEY }}
        port: 22
        script: |
          killall java
          nohup java -jar /home/ec2-user/target/TSA-New.jar > log.txt &
          sudo iptables -t nat -I PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
          sudo iptables -I INPUT -p tcp --dport 8080 -j ACCEPT
